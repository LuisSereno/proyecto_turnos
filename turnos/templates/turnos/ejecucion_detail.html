{% extends 'base.html' %}
{% load static %}
{% load i18n %}
{% load turnos_extras %}

{% block title %}{{ ejecucion.configuracion.nombre }}{% endblock %}

{% block extra_css %}
<link rel="stylesheet" href="{% static 'css/planilla.css' %}">
{% endblock %}

{% block breadcrumb_items %}
    <li class="breadcrumb-item"><a href="{% url 'turnos:ejecucion_lista' %}">{% trans "Ejecuciones" %}</a></li>
    <li class="breadcrumb-item active">{{ ejecucion.configuracion.nombre }}</li>
{% endblock %}

{% block content %}
<div class="ejecucion-header mb-4">
    <div class="row align-items-center">
        <div class="col-md-8">
            <h2 class="mb-2">{{ ejecucion.configuracion.nombre }}</h2>
            <div class="d-flex gap-3 align-items-center">
                {{ ejecucion.estado|estado_badge }}
                {% if ejecucion.es_optima %}
                    <span class="badge bg-success">
                        <i class="fas fa-star me-1"></i>{% trans "Óptima" %}
                    </span>
                {% endif %}
                <span class="text-muted">
                    <i class="fas fa-clock me-1"></i>{{ ejecucion.fecha_inicio|date:"d/m/Y H:i" }}
                </span>
            </div>
        </div>
        <div class="col-md-4 text-end">
            <div class="btn-group">
                <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown">
                    <i class="fas fa-download me-2"></i>{% trans "Exportar" %}
                </button>
                <ul class="dropdown-menu">
                    <li>
                        <a class="dropdown-item" href="{% url 'turnos:ejecucion_exportar_excel' ejecucion.id %}">
                            <i class="fas fa-file-excel me-2 text-success"></i>{% trans "Excel (.xlsx)" %}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'turnos:ejecucion_exportar_pdf' ejecucion.id %}">
                            <i class="fas fa-file-pdf me-2 text-danger"></i>{% trans "PDF" %}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'turnos:ejecucion_exportar_csv' ejecucion.id %}">
                            <i class="fas fa-file-csv me-2 text-info"></i>{% trans "CSV" %}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'turnos:ejecucion_exportar_json' ejecucion.id %}">
                            <i class="fas fa-file-code me-2 text-warning"></i>{% trans "JSON" %}
                        </a>
                    </li>
                    <li>
                        <a class="dropdown-item" href="{% url 'turnos:ejecucion_exportar_ical' ejecucion.id %}">
                            <i class="fas fa-calendar me-2 text-primary"></i>{% trans "iCalendar (.ics)" %}
                        </a>
                    </li>
                </ul>
            </div>
            <a href="{% url 'turnos:ejecucion_eliminar' ejecucion.id %}" class="btn btn-outline-danger">
                <i class="fas fa-trash"></i>
            </a>
        </div>
    </div>
</div>

{% if ejecucion.estado == 'COMPLETADA' %}
<ul class="nav nav-tabs mb-4" role="tablist">
    <li class="nav-item">
        <button class="nav-link active" data-bs-toggle="tab" data-bs-target="#planilla">
            <i class="fas fa-calendar-alt me-2"></i>{% trans "Planilla" %}
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#estadisticas">
            <i class="fas fa-chart-bar me-2"></i>{% trans "Estadísticas" %}
        </button>
    </li>
    <li class="nav-item">
        <button class="nav-link" data-bs-toggle="tab" data-bs-target="#detalles">
            <i class="fas fa-info-circle me-2"></i>{% trans "Detalles" %}
        </button>
    </li>
</ul>

<div class="tab-content">
    <!-- Planilla -->
    <div class="tab-pane fade show active" id="planilla">
        {% include 'turnos/partials/planilla_tabla.html' with planilla=ejecucion.planilla %}
    </div>

    <!-- Estadísticas -->
    <div class="tab-pane fade" id="estadisticas">
        {% include 'turnos/partials/estadisticas.html' with ejecucion=ejecucion %}
    </div>

    <!-- Detalles -->
    <div class="tab-pane fade" id="detalles">
        <div class="card">
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h5>{% trans "Información de Ejecución" %}</h5>
                        <table class="table">
                            <tr>
                                <th>{% trans "Configuración:" %}</th>
                                <td>
                                    <a href="{% url 'turnos:config_detalle' ejecucion.configuracion.id %}">
                                        {{ ejecucion.configuracion.nombre }}
                                    </a>
                                </td>
                            </tr>
                            <tr>
                                <th>{% trans "Estado:" %}</th>
                                <td>{{ ejecucion.estado|estado_badge }}</td>
                            </tr>
                            <tr>
                                <th>{% trans "Fecha Inicio:" %}</th>
                                <td>{{ ejecucion.fecha_inicio|date:"d/m/Y H:i:s" }}</td>
                            </tr>
                            <tr>
                                <th>{% trans "Fecha Fin:" %}</th>
                                <td>{{ ejecucion.fecha_fin|date:"d/m/Y H:i:s" }}</td>
                            </tr>
                            <tr>
                                <th>{% trans "Duración:" %}</th>
                                <td>{{ ejecucion.duracion|format_duration }}</td>
                            </tr>
                        </table>
                    </div>
                    <div class="col-md-6">
                        <h5>{% trans "Resultados" %}</h5>
                        <table class="table">
                            <tr>
                                <th>{% trans "Penalización Total:" %}</th>
                                <td class="fw-bold">{{ ejecucion.penalizacion_total|floatformat:2 }}</td>
                            </tr>
                            <tr>
                                <th>{% trans "Es Óptima:" %}</th>
                                <td>
                                    {% if ejecucion.es_optima %}
                                        <span class="badge bg-success">{% trans "Sí" %}</span>
                                    {% else %}
                                        <span class="badge bg-warning">{% trans "No" %}</span>
                                    {% endif %}
                                </td>
                            </tr>
                            <tr>
                                <th>{% trans "Número de Trabajadores:" %}</th>
                                <td>{{ ejecucion.configuracion.num_trabajadores }}</td>
                            </tr>
                            <tr>
                                <th>{% trans "Tiempo Límite:" %}</th>
                                <td>{{ ejecucion.configuracion.tiempo_maximo_segundos }}s</td>
                            </tr>
                        </table>

                        {% if ejecucion.mensajes %}
                        <div class="mt-3">
                            <h6>{% trans "Mensajes:" %}</h6>
                            <pre class="bg-light p-3 rounded">{{ ejecucion.mensajes|jsonify }}</pre>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% elif ejecucion.estado == 'ERROR' %}
<div class="alert alert-danger">
    <h5><i class="fas fa-exclamation-circle me-2"></i>{% trans "Error en la Ejecución" %}</h5>
    {% if ejecucion.mensajes.errores %}
        <ul class="mb-0">
            {% for error in ejecucion.mensajes.errores %}
                <li>{{ error }}</li>
            {% endfor %}
        </ul>
    {% else %}
        <p class="mb-0">{% trans "La ejecución falló. Revisa la configuración e intenta nuevamente." %}</p>
    {% endif %}
</div>
{% elif ejecucion.estado == 'PROCESANDO' %}
<div class="text-center py-5">
    <div class="spinner-border text-primary mb-3" style="width: 4rem; height: 4rem;"></div>
    <h4>{% trans "Procesando Planificación..." %}</h4>
    <p class="text-muted">{% trans "Esto puede tomar varios minutos" %}</p>
    <div class="progress mt-4" style="height: 25px;">
        <div class="progress-bar progress-bar-striped progress-bar-animated" 
             role="progressbar" 
             style="width: 50%">
            {% trans "En progreso..." %}
        </div>
    </div>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<script src="{% static 'js/planilla.js' %}"></script>
{% endblock %}
